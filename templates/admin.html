<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="admin_page_title">ç®¡ç†å‘˜æ§åˆ¶å° - ç è¨€æ——ä¸‹ Nano Banana Pro</title>
    <link rel="icon" href="/static/logo.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="/static/fonts/inter.css" rel="stylesheet">
    <!-- Flatpickr æ—¥æœŸé€‰æ‹©å™¨ (æœ¬åœ°æ–‡ä»¶) -->
    <link rel="stylesheet" href="/static/lib/flatpickr/flatpickr.min.css">
    <link rel="stylesheet" href="/static/lib/flatpickr/dark.css">
    <script src="/static/lib/flatpickr/flatpickr.min.js"></script>
    <script src="/static/lib/flatpickr/zh.js"></script>
    <script src="/static/js/i18n.js"></script>
</head>

<body class="admin-page">
    <div class="admin-container">
        <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
        <header class="admin-header">
            <div class="admin-title-section">
                <h1 class="admin-title" data-i18n="admin_title">ğŸ›¡ï¸ ç®¡ç†å‘˜æ§åˆ¶å°</h1>
                <p class="admin-subtitle" data-i18n="admin_subtitle">ç”¨æˆ·ç®¡ç†ä¸æ•°æ®ç›‘æ§</p>
            </div>
            <div class="admin-actions">
                <!-- è¯­è¨€åˆ‡æ¢ -->
                <div class="lang-switch">
                    <button class="lang-btn" data-lang="zh">ä¸­</button>
                    <button class="lang-btn" data-lang="en">EN</button>
                </div>
                <a href="/" class="btn-back" data-i18n="back_home">â† è¿”å›ä¸»é¡µ</a>
                <a href="/api/logout" class="btn-logout" data-i18n="logout_btn">é€€å‡ºç™»å½•</a>
            </div>
        </header>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-info">
                    <span class="stat-value" id="totalUsers">-</span>
                    <span class="stat-label" data-i18n="total_users">æ€»ç”¨æˆ·æ•°</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ’¬</div>
                <div class="stat-info">
                    <span class="stat-value" id="totalSessions">-</span>
                    <span class="stat-label" data-i18n="total_sessions">æ€»ä¼šè¯æ•°</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“</div>
                <div class="stat-info">
                    <span class="stat-value" id="totalMessages">-</span>
                    <span class="stat-label" data-i18n="total_messages">æ€»æ¶ˆæ¯æ•°</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ”</div>
                <div class="stat-info">
                    <span class="stat-value" id="totalAdmins">-</span>
                    <span class="stat-label" data-i18n="total_admins">ç®¡ç†å‘˜æ•°</span>
                </div>
            </div>
        </div>

        <!-- æ•°æ®æ¸…ç† -->
        <div class="admin-section">
            <h2 class="section-title" data-i18n="data_cleanup">æ•°æ®æ¸…ç†</h2>
            <div class="cleanup-controls">
                <div class="cleanup-group">
                    <p class="cleanup-desc" data-i18n="quick_cleanup_desc">å¿«é€Ÿæ¸…ç†ï¼šæ¸…ç†7å¤©å‰çš„æ‰€æœ‰æ•°æ®ï¼ˆåŒ…å«å›¾ç‰‡ã€ç¼©ç•¥å›¾ã€å­¤å„¿æ–‡ä»¶ï¼‰</p>
                    <button class="btn-cleanup btn-warning" onclick="cleanupData(7)" data-i18n="cleanup_7days">ğŸ—‘ï¸
                        æ¸…ç†7å¤©å‰æ•°æ®</button>
                </div>
                <div class="cleanup-group">
                    <p class="cleanup-desc" data-i18n="cleanup_all_desc">æ¸…ç†æ‰€æœ‰æ•°æ®ï¼šåˆ é™¤å…¨éƒ¨ä¼šè¯ã€å›¾ç‰‡ã€ç¼©ç•¥å›¾</p>
                    <button class="btn-cleanup btn-danger" onclick="cleanupAllData()" data-i18n="cleanup_all">ğŸ—‘ï¸ æ¸…ç†æ‰€æœ‰æ•°æ®</button>
                </div>
                <div class="cleanup-group">
                    <p class="cleanup-desc" data-i18n="custom_cleanup_desc">è‡ªå®šä¹‰æ¸…ç†ï¼šæ¸…ç†æŒ‡å®šæ—¥æœŸå‰çš„æ‰€æœ‰æ•°æ®ï¼ˆåŒ…å«å›¾ç‰‡ã€ç¼©ç•¥å›¾ã€å­¤å„¿æ–‡ä»¶ï¼‰</p>
                    <div class="date-cleanup-input">
                        <input type="text" id="cleanupDate" class="date-input" placeholder="YYYY-MM-DD" readonly>
                        <button class="btn-cleanup btn-danger" onclick="cleanupDataCustom()"
                            data-i18n="execute_cleanup">ğŸ—‘ï¸ æ‰§è¡Œæ¸…ç†</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¡å¯†ç®¡ç† -->
        <div class="admin-section">
            <h2 class="section-title" data-i18n="card_key_mgmt">ğŸ”‘ å¡å¯†ç®¡ç†</h2>
            <div class="card-key-controls">
                <div class="card-key-form">
                    <div class="form-row">
                        <div class="form-group-inline">
                            <label data-i18n="credits_per_card">æ¯å¼ ç‚¹æ•°</label>
                            <input type="number" id="cardKeyCredits" class="form-input" value="10" min="1" max="10000">
                        </div>
                        <div class="form-group-inline">
                            <label data-i18n="generate_count">ç”Ÿæˆæ•°é‡</label>
                            <input type="number" id="cardKeyCount" class="form-input" value="10" min="1" max="100">
                        </div>
                        <button class="btn-generate-keys" onclick="generateCardKeys()" data-i18n="generate_keys">ğŸ«
                            ç”Ÿæˆå¡å¯†</button>
                    </div>
                </div>
                <div
                    style="margin-top: 12px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-left: 3px solid #f59e0b; border-radius: 8px;">
                    <p style="font-size: 0.85rem; color: #f59e0b; margin: 0;">
                        <strong data-i18n="security_tip">ğŸ”’ å®‰å…¨æç¤ºï¼š</strong><span
                            data-i18n-html="security_tip_msg">å¡å¯†ä½¿ç”¨å“ˆå¸ŒåŠ å¯†å­˜å‚¨ï¼Œç”Ÿæˆå<strong>åªæ˜¾ç¤ºä¸€æ¬¡</strong>ï¼Œè¯·ç«‹å³ä¿å­˜ï¼</span>
                    </p>
                </div>
                <div class="card-key-table-container">
                    <table class="user-table card-key-table">
                        <thead>
                            <tr>
                                <th data-i18n="card_key_code">å¡å¯†ç </th>
                                <th data-i18n="credits">ç‚¹æ•°</th>
                                <th data-i18n="status">çŠ¶æ€</th>
                                <th data-i18n="used_by">ä½¿ç”¨è€…</th>
                                <th data-i18n="created_at">åˆ›å»ºæ—¶é—´</th>
                                <th data-i18n="actions">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="cardKeyTableBody">
                            <tr>
                                <td colspan="6" class="loading-cell" data-i18n="loading">åŠ è½½ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ç”¨æˆ·åˆ—è¡¨ -->
        <div class="admin-section">
            <h2 class="section-title" data-i18n="user_list">ç”¨æˆ·åˆ—è¡¨</h2>
            <div class="user-table-container">
                <table class="user-table">
                    <thead>
                        <tr>
                            <th data-i18n="id">ID</th>
                            <th data-i18n="username">ç”¨æˆ·å</th>
                            <th data-i18n="role">è§’è‰²</th>
                            <th data-i18n="credits">ç‚¹æ•°</th>
                            <th data-i18n="session_count">ä¼šè¯æ•°</th>
                            <th data-i18n="message_count">æ¶ˆæ¯æ•°</th>
                            <th data-i18n="register_time">æ³¨å†Œæ—¶é—´</th>
                            <th data-i18n="actions">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <tr>
                            <td colspan="8" class="loading-cell" data-i18n="loading">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ç”¨æˆ·ä¼šè¯è¯¦æƒ…æ¨¡æ€æ¡† (Master-Detail Layout) -->
        <div class="modal" id="sessionModal" hidden>
            <div class="modal-backdrop" onclick="closeSessionModal()"></div>
            <div class="modal-content modal-large-xl">
                <div class="modal-header">
                    <h3 id="modalTitle" data-i18n="session_detail">ç”¨æˆ·ä¼šè¯è¯¦æƒ…</h3>
                    <button class="modal-close" onclick="closeSessionModal()">Ã—</button>
                </div>
                <div class="modal-body" id="sessionModalBody" style="padding: 0; overflow: hidden;">
                    <!-- Content will be injected here -->
                    <div class="session-viewer-container">
                        <div class="session-viewer-sidebar">
                            <div class="session-viewer-sidebar-header" data-i18n="session_list">
                                ä¼šè¯åˆ—è¡¨
                            </div>
                            <div class="session-viewer-list" id="sessionSidebarList">
                                <!-- List Items -->
                            </div>
                        </div>
                        <div class="session-viewer-main">
                            <div class="session-viewer-content" id="sessionMainContent">
                                <!-- Chat Content -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† (Lightbox) -->
        <div class="image-modal" id="adminImageModal" hidden>
            <div class="modal-backdrop" onclick="closeImagePreview()"></div>
            <div class="modal-content">
                <img id="adminModalImage" src="" alt="" data-i18n-title="image_preview">
                <div class="modal-actions">
                    <a class="btn-download" id="adminBtnDownload" download data-i18n-html="download_image">
                        <span>ğŸ“¥</span> ä¸‹è½½å›¾ç‰‡
                    </a>
                    <button class="btn-close-modal" onclick="closeImagePreview()">âœ•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥è‡ªå®šä¹‰ Modal æ ·å¼ -->
    <link rel="stylesheet" href="/static/css/modal.css">
    <!-- å¼•å…¥è‡ªå®šä¹‰ Modal è„šæœ¬ -->
    <script src="/static/js/modal.js"></script>

    <script>
        let users = [];
        let currentSessions = []; // Store current user sessions

        // åŠ è½½ç”¨æˆ·æ•°æ®
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                if (response.ok) {
                    users = await response.json();
                    renderUsers();
                    updateStats();
                } else if (response.status === 401) {
                    window.location.href = '/login';
                } else if (response.status === 403) {
                    await Modal.alert(I18n.t('permission_error'), I18n.t('no_admin_permission'), 'error');
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Load users failed:', error);
                Modal.toast(I18n.t('load_users_failed'), 'error');
            }
        }

        // æ¸²æŸ“ç”¨æˆ·è¡¨æ ¼
        function renderUsers() {
            const tbody = document.getElementById('userTableBody');
            if (users.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="empty-cell">${I18n.t('no_users')}</td></tr>`;
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr class="${user.is_admin ? 'admin-row' : ''}">
                    <td>${user.id}</td>
                    <td>
                        <span class="username">${user.username}</span>
                        ${user.username === 'admin' ? `<span class="badge badge-primary">${I18n.t('main_admin')}</span>` : ''}
                    </td>
                    <td>
                        <span class="badge ${user.is_admin ? 'badge-admin' : 'badge-user'}">
                            ${user.is_admin ? I18n.t('admin') : I18n.t('normal_user')}
                        </span>
                    </td>
                    <td>${user.credits !== undefined ? user.credits : '-'}</td>
                    <td>${user.session_count || 0}</td>
                    <td>${user.message_count || 0}</td>
                    <td>${formatDate(user.created_at)}</td>
                    <td class="action-cell">
                        <button class="btn-action btn-view" onclick="viewSessions(${user.id}, '${user.username}')">
                            ${I18n.t('view_sessions')}
                        </button>
                        ${user.username !== 'admin' ? `
                            <button class="btn-action btn-toggle" onclick="toggleAdmin(${user.id})">
                                ${user.is_admin ? I18n.t('revoke_admin') : I18n.t('set_admin')}
                            </button>
                            <button class="btn-action btn-view" onclick="addCredits(${user.id}, '${user.username}')">
                                ${I18n.t('add_credits')}
                            </button>
                            <button class="btn-action btn-delete" onclick="deleteUser(${user.id}, '${user.username}')">
                                ${I18n.t('delete_user')}
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('totalSessions').textContent = users.reduce((sum, u) => sum + (u.session_count || 0), 0);
            document.getElementById('totalMessages').textContent = users.reduce((sum, u) => sum + (u.message_count || 0), 0);
            document.getElementById('totalAdmins').textContent = users.filter(u => u.is_admin).length;
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            // æ ¹æ®å½“å‰è¯­è¨€é€‰æ‹©æ—¥æœŸæ ¼å¼
            const locale = I18n.getLang() === 'zh' ? 'zh-CN' : 'en-US';
            return date.toLocaleString(locale, {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // æŸ¥çœ‹ç”¨æˆ·ä¼šè¯
        async function viewSessions(userId, username) {
            document.getElementById('modalTitle').textContent = `${username} - ${I18n.t('session_detail')}`;
            document.getElementById('sessionModal').hidden = false;

            // Reset UI
            const sidebarList = document.getElementById('sessionSidebarList');
            const mainContent = document.getElementById('sessionMainContent');
            sidebarList.innerHTML = `<div style="padding:10px; color:var(--text-muted)">${I18n.t('loading')}</div>`;
            mainContent.innerHTML = '';

            try {
                const response = await fetch(`/api/admin/users/${userId}/sessions`);
                currentSessions = await response.json();

                if (currentSessions.length === 0) {
                    sidebarList.innerHTML = `<div style="padding:10px; color:var(--text-muted)">${I18n.t('no_sessions')}</div>`;
                    renderEmptyState();
                    return;
                }

                renderSessionList();
                // Select first session by default
                if (currentSessions.length > 0) {
                    selectSession(currentSessions[0].id);
                }

            } catch (error) {
                sidebarList.innerHTML = `<div style="padding:10px; color:var(--error)">${I18n.t('load_sessions_failed')}</div>`;
                Modal.toast(I18n.t('load_sessions_failed'), 'error');
            }
        }

        function renderSessionList() {
            const sidebarList = document.getElementById('sessionSidebarList');
            sidebarList.innerHTML = currentSessions.map(session => {
                // ç¿»è¯‘ä¼šè¯æ ‡é¢˜ï¼ˆå¦‚æœæ˜¯é»˜è®¤çš„"æ–°å¯¹è¯"ï¼‰
                const title = session.title === 'æ–°å¯¹è¯' ? I18n.t('new_chat') : session.title;
                return `
                <div class="session-list-item" id="session-item-${session.id}" onclick="selectSession('${session.id}')">
                    <div class="session-list-item-title">${title}</div>
                    <div class="session-list-item-date">${formatDate(session.updated_at)} Â· ${session.messages.length} ${I18n.t('messages_count')}</div>
                </div>
            `}).join('');
        }

        function selectSession(sessionId) {
            // Update active state in sidebar
            document.querySelectorAll('.session-list-item').forEach(el => el.classList.remove('active'));
            const activeItem = document.getElementById(`session-item-${sessionId}`);
            if (activeItem) activeItem.classList.add('active');

            // Render messages
            const session = currentSessions.find(s => s.id === sessionId);
            const mainContent = document.getElementById('sessionMainContent');

            if (!session || !session.messages || session.messages.length === 0) {
                mainContent.innerHTML = `
                    <div class="viewer-empty">
                        <div class="viewer-empty-icon">ğŸ’¬</div>
                        <p>${I18n.t('no_messages')}</p>
                    </div>
                `;
                return;
            }

            mainContent.innerHTML = session.messages.map(msg => `
                <div class="viewer-message ${msg.role}">
                    <div class="viewer-avatar">${msg.role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–'}</div>
                    <div class="viewer-content-wrapper">
                         <div class="viewer-bubble">
                            ${msg.content || ''}
                            ${msg.image ? `<img src="${msg.thumbnail || msg.image}" class="viewer-image" alt="${I18n.t('generated_image')}" onclick="openImagePreview('${msg.image}')">` : ''}
                        </div>
                         <!-- Reference Images -->
                         ${msg.reference_images ? `
                            <div style="margin-top: 5px; display: flex; gap: 5px; flex-wrap: wrap;">
                                ${msg.reference_images.map(ref => `
                                    <img src="/static/images/${ref}" style="width: 40px; height: 40px; border-radius: 4px; object-fit: cover; border: 1px solid rgba(255,255,255,0.1);">
                                `).join('')}
                            </div>
                         ` : ''}
                    </div>
                </div>
            `).join('');

            // Scroll to bottom
            setTimeout(() => {
                mainContent.scrollTop = mainContent.scrollHeight;
            }, 0);
        }

        function renderEmptyState() {
            const mainContent = document.getElementById('sessionMainContent');
            mainContent.innerHTML = `
                <div class="viewer-empty">
                    <div class="viewer-empty-icon">ğŸ“‚</div>
                    <p>${I18n.t('select_session')}</p>
                </div>
            `;
        }

        // å…³é—­ä¼šè¯æ¨¡æ€æ¡†
        function closeSessionModal() {
            document.getElementById('sessionModal').hidden = true;
        }

        // åˆ‡æ¢ç®¡ç†å‘˜çŠ¶æ€
        async function toggleAdmin(userId) {
            try {
                const response = await fetch(`/api/admin/users/${userId}/toggle-admin`, {
                    method: 'POST'
                });
                const data = await response.json();
                if (response.ok) {
                    Modal.toast(I18n.t('operation_success'), 'success');
                    loadUsers();
                } else {
                    Modal.alert(I18n.t('operation_failed'), I18n.translateError(data.error, 'unknown_error'), 'error');
                }
            } catch (error) {
                Modal.alert(I18n.t('network_error'), I18n.t('connect_error'), 'error');
            }
        }

        // åˆ é™¤ç”¨æˆ·
        async function deleteUser(userId, username) {
            const confirmed = await Modal.confirm(I18n.t('delete_user'), I18n.t('confirm_delete_user', username), 'warning');
            if (!confirmed) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (response.ok) {
                    Modal.toast(I18n.t('user_deleted', username), 'success');
                    loadUsers();
                } else {
                    Modal.alert(I18n.t('delete_failed'), I18n.translateError(data.error, 'unknown_error'), 'error');
                }
            } catch (error) {
                Modal.alert(I18n.t('network_error'), I18n.t('connect_error'), 'error');
            }
        }

        // ç»™ç”¨æˆ·å……å€¼
        async function addCredits(userId, username) {
            const amountStr = await Modal.prompt(I18n.t('credits_recharge'), I18n.t('credits_recharge_prompt', username), '10');
            if (amountStr === null) return;

            const amount = parseInt(amountStr);
            if (isNaN(amount) || amount === 0) {
                Modal.toast(I18n.t('invalid_number'), 'warning');
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}/credits`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount })
                });
                const data = await response.json();

                if (response.ok) {
                    await Modal.alert(I18n.t('recharge_success'), I18n.t('recharge_success_msg', data.new_credits), 'success');
                    loadUsers();
                } else {
                    Modal.alert(I18n.t('recharge_failed'), I18n.translateError(data.error, 'operation_failed'), 'error');
                }
            } catch (error) {
                Modal.alert(I18n.t('network_error'), I18n.t('connect_error'), 'error');
            }
        }

        // æ•°æ®æ¸…ç†å‡½æ•°
        async function cleanupData(days) {
            const confirmed = await Modal.confirm(I18n.t('confirm_cleanup'), I18n.t('confirm_cleanup_msg', days), 'warning');
            if (!confirmed) {
                return;
            }

            const date = new Date();
            date.setDate(date.getDate() - days);
            const cutoffDate = date.toISOString().split('T')[0];

            await performCleanup(cutoffDate);
        }

        async function cleanupAllData() {
            const confirmed = await Modal.confirm(
                I18n.t('cleanup_all_title') || 'æ¸…ç†æ‰€æœ‰æ•°æ®',
                I18n.t('cleanup_all_msg') || 'ç¡®å®šè¦æ¸…ç†æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œå°†åˆ é™¤å…¨éƒ¨ä¼šè¯ã€å›¾ç‰‡å’Œç¼©ç•¥å›¾ï¼Œä¸”ä¸å¯æ¢å¤ï¼',
                'warning'
            );
            if (!confirmed) {
                return;
            }

            // ç”¨æ˜å¤©çš„æ—¥æœŸä½œä¸ºæˆªæ­¢æ—¥æœŸï¼Œç¡®ä¿æ‰€æœ‰æ•°æ®éƒ½è¢«æ¸…ç†
            const date = new Date();
            date.setDate(date.getDate() + 1);
            const cutoffDate = date.toISOString().split('T')[0];

            await performCleanup(cutoffDate);
        }

        async function cleanupDataCustom() {
            const dateInput = document.getElementById('cleanupDate');
            const cutoffDate = dateInput.value;

            if (!cutoffDate) {
                Modal.toast(I18n.t('select_date'), 'warning');
                return;
            }

            const confirmed = await Modal.confirm(I18n.t('custom_cleanup'), I18n.t('custom_cleanup_msg', cutoffDate), 'warning');
            if (!confirmed) {
                return;
            }

            await performCleanup(cutoffDate);
        }

        async function performCleanup(cutoffDate) {
            try {
                const response = await fetch('/api/admin/cleanup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cutoff_date: cutoffDate })
                });

                const data = await response.json();

                if (response.ok) {
                    const stats = data.deleted_stats;
                    let message = `${I18n.t('cleanup_complete')}!\nMessages: ${stats.messages}\nImages: ${stats.images}\nSessions: ${stats.sessions}`;
                    if (stats.orphan_images > 0 || stats.orphan_thumbnails > 0) {
                        message += `\n\nOrphan files:\n- Images: ${stats.orphan_images}\n- Thumbnails: ${stats.orphan_thumbnails}`;
                    }
                    await Modal.alert(I18n.t('cleanup_complete'), message, 'success');
                    loadUsers();
                } else {
                    Modal.alert(I18n.t('cleanup_failed'), I18n.translateError(data.error, 'operation_failed'), 'error');
                }
            } catch (error) {
                Modal.alert(I18n.t('network_error'), I18n.t('connect_error'), 'error');
            }
        }

        // å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
        function openImagePreview(imageSrc) {
            const modal = document.getElementById('adminImageModal');
            const img = document.getElementById('adminModalImage');
            const downloadBtn = document.getElementById('adminBtnDownload');

            img.src = imageSrc;
            downloadBtn.href = imageSrc;
            modal.hidden = false;
        }

        function closeImagePreview() {
            document.getElementById('adminImageModal').hidden = true;
        }

        // ========================================
        // å¡å¯†ç®¡ç†åŠŸèƒ½
        // ========================================
        let cardKeys = [];

        async function loadCardKeys() {
            try {
                const response = await fetch('/api/admin/card-keys');
                if (response.ok) {
                    cardKeys = await response.json();
                    renderCardKeys();
                }
            } catch (error) {
                console.error('åŠ è½½å¡å¯†å¤±è´¥:', error);
            }
        }

        function renderCardKeys() {
            const tbody = document.getElementById('cardKeyTableBody');
            if (cardKeys.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="empty-cell">${I18n.t('no_cards')}</td></tr>`;
                return;
            }

            tbody.innerHTML = cardKeys.map(key => `
                <tr class="${key.is_used ? 'used-row' : ''}">
                    <td>
                        <code class="card-key-code">${key.code_prefix}****-****-****</code>
                    </td>
                    <td><span class="credits-badge">ğŸª™ ${key.credits}</span></td>
                    <td>
                        <span class="badge ${key.is_used ? 'badge-used' : 'badge-available'}">
                            ${key.is_used ? I18n.t('used') : I18n.t('available')}
                        </span>
                    </td>
                    <td>${key.used_by_username || '-'}</td>
                    <td>${formatDate(key.created_at)}</td>
                    <td>-</td>
                </tr>
            `).join('');
        }

        async function generateCardKeys() {
            const credits = parseInt(document.getElementById('cardKeyCredits').value);
            const count = parseInt(document.getElementById('cardKeyCount').value);

            if (isNaN(credits) || credits <= 0) {
                Modal.toast(I18n.t('invalid_credits'), 'warning');
                return;
            }
            if (isNaN(count) || count <= 0 || count > 100) {
                Modal.toast(I18n.t('credits_must_range'), 'warning');
                return;
            }

            try {
                const response = await fetch('/api/admin/card-keys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ credits, count })
                });

                const data = await response.json();

                if (response.ok) {
                    const keysHTML = data.keys.map(key => `
                        <div style="margin-bottom: 8px; padding: 10px; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">
                            <code style="font-size: 1rem; font-weight: 600; color: var(--accent-purple-light); letter-spacing: 1px;">${key.code}</code>
                            <button onclick="navigator.clipboard.writeText('${key.code}').then(() => Modal.toast('${I18n.t('copied')}', 'success'))" style="margin-left: 10px; padding: 4px 8px; background: rgba(99, 102, 241, 0.2); color: var(--accent-blue); border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">${I18n.t('copy')}</button>
                        </div>
                    `).join('');

                    await Modal.alert(
                        I18n.t('keys_generated'),
                        `<div style="max-height: 400px; overflow-y: auto;">
                            <p style="color: #f59e0b; font-weight: 600; margin-bottom: 12px;">${I18n.t('save_keys_warning')}</p>
                            ${keysHTML}
                        </div>`,
                        'success'
                    );
                    loadCardKeys();
                } else {
                    Modal.alert(I18n.t('generate_failed_msg'), I18n.translateError(data.error, 'operation_failed'), 'error');
                }
            } catch (error) {
                Modal.alert(I18n.t('network_error'), I18n.t('connect_error'), 'error');
            }
        }

        function copyCardKey(code) {
            navigator.clipboard.writeText(code).then(() => {
                Modal.toast(I18n.t('key_copied'), 'success');
            }).catch(() => {
                Modal.toast(I18n.t('copy_failed'), 'error');
            });
        }

        // åˆå§‹åŒ– Flatpickr æ—¥æœŸé€‰æ‹©å™¨
        let datePicker = null;

        function initDatePicker() {
            const dateInput = document.getElementById('cleanupDate');
            if (!dateInput) return;

            // å¦‚æœå·²å­˜åœ¨å®ä¾‹ï¼Œå…ˆé”€æ¯
            if (datePicker) {
                datePicker.destroy();
            }

            // åˆå§‹åŒ– Flatpickr
            datePicker = flatpickr(dateInput, {
                locale: I18n.getLang() === 'zh' ? 'zh' : 'default',
                dateFormat: 'Y-m-d',
                maxDate: 'today',
                disableMobile: true,  // ç¦ç”¨ç§»åŠ¨ç«¯åŸç”Ÿé€‰æ‹©å™¨ï¼Œç»Ÿä¸€ä½¿ç”¨ Flatpickr
                theme: 'dark'
            });
        }

        // ç›‘å¬è¯­è¨€åˆ‡æ¢
        I18n.onLangChange(() => {
            initDatePicker();
            // é‡æ–°æ¸²æŸ“ç”¨æˆ·è¡¨æ ¼å’Œå¡å¯†è¡¨æ ¼ä»¥æ›´æ–°ç¿»è¯‘
            renderUsers();
            renderCardKeys();
        });

        // åˆå§‹åŒ–
        initDatePicker();
        loadUsers();
        loadCardKeys();
    </script>
</body>

</html>