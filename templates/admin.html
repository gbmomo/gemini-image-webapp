<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜æ§åˆ¶å° - Nano Banana Pro</title>
    <link rel="icon" href="/static/logo.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="/static/fonts/inter.css" rel="stylesheet">
</head>

<body class="admin-page">
    <div class="admin-container">
        <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
        <header class="admin-header">
            <div class="admin-title-section">
                <h1 class="admin-title">ğŸ›¡ï¸ ç®¡ç†å‘˜æ§åˆ¶å°</h1>
                <p class="admin-subtitle">ç”¨æˆ·ç®¡ç†ä¸æ•°æ®ç›‘æ§</p>
            </div>
            <div class="admin-actions">
                <a href="/" class="btn-back">â† è¿”å›ä¸»é¡µ</a>
                <a href="/api/logout" class="btn-logout">é€€å‡ºç™»å½•</a>
            </div>
        </header>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <!-- (existing cards) -->
            <div class="stat-card">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-info">
                    <span class="stat-value" id="totalUsers">-</span>
                    <span class="stat-label">æ€»ç”¨æˆ·æ•°</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ’¬</div>
                <div class="stat-info">
                    <span class="stat-value" id="totalSessions">-</span>
                    <span class="stat-label">æ€»ä¼šè¯æ•°</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“</div>
                <div class="stat-info">
                    <span class="stat-value" id="totalMessages">-</span>
                    <span class="stat-label">æ€»æ¶ˆæ¯æ•°</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ”</div>
                <div class="stat-info">
                    <span class="stat-value" id="totalAdmins">-</span>
                    <span class="stat-label">ç®¡ç†å‘˜æ•°</span>
                </div>
            </div>
        </div>

        <!-- æ•°æ®æ¸…ç† -->
        <div class="admin-section">
            <h2 class="section-title">æ•°æ®æ¸…ç†</h2>
            <div class="cleanup-controls">
                <div class="cleanup-group">
                    <p class="cleanup-desc">å¿«é€Ÿæ¸…ç†ï¼šæ¸…ç†7å¤©å‰çš„æ‰€æœ‰æ•°æ®ï¼ˆåŒ…å«å›¾ç‰‡ã€ç¼©ç•¥å›¾ã€å­¤å„¿æ–‡ä»¶ï¼‰</p>
                    <button class="btn-cleanup btn-warning" onclick="cleanupData(7)">ğŸ—‘ï¸ æ¸…ç†7å¤©å‰æ•°æ®</button>
                </div>
                <div class="cleanup-group">
                    <p class="cleanup-desc">è‡ªå®šä¹‰æ¸…ç†ï¼šæ¸…ç†æŒ‡å®šæ—¥æœŸå‰çš„æ‰€æœ‰æ•°æ®ï¼ˆåŒ…å«å›¾ç‰‡ã€ç¼©ç•¥å›¾ã€å­¤å„¿æ–‡ä»¶ï¼‰</p>
                    <div class="date-cleanup-input">
                        <input type="date" id="cleanupDate" class="date-input">
                        <button class="btn-cleanup btn-danger" onclick="cleanupDataCustom()">ğŸ—‘ï¸ æ‰§è¡Œæ¸…ç†</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¡å¯†ç®¡ç† -->
        <div class="admin-section">
            <h2 class="section-title">ğŸ”‘ å¡å¯†ç®¡ç†</h2>
            <div class="card-key-controls">
                <div class="card-key-form">
                    <div class="form-row">
                        <div class="form-group-inline">
                            <label>æ¯å¼ ç‚¹æ•°</label>
                            <input type="number" id="cardKeyCredits" class="form-input" value="10" min="1" max="10000">
                        </div>
                        <div class="form-group-inline">
                            <label>ç”Ÿæˆæ•°é‡</label>
                            <input type="number" id="cardKeyCount" class="form-input" value="10" min="1" max="100">
                        </div>
                        <button class="btn-generate-keys" onclick="generateCardKeys()">ğŸ« ç”Ÿæˆå¡å¯†</button>
                    </div>
                </div>
                <div
                    style="margin-top: 12px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-left: 3px solid #f59e0b; border-radius: 8px;">
                    <p style="font-size: 0.85rem; color: #f59e0b; margin: 0;">
                        <strong>ğŸ”’ å®‰å…¨æç¤ºï¼š</strong>å¡å¯†ä½¿ç”¨å“ˆå¸ŒåŠ å¯†å­˜å‚¨ï¼Œç”Ÿæˆå<strong>åªæ˜¾ç¤ºä¸€æ¬¡</strong>ï¼Œè¯·ç«‹å³ä¿å­˜ï¼
                    </p>
                </div>
                <div class="card-key-table-container">
                    <table class="user-table card-key-table">
                        <thead>
                            <tr>
                                <th>å¡å¯†ç </th>
                                <th>ç‚¹æ•°</th>
                                <th>çŠ¶æ€</th>
                                <th>ä½¿ç”¨è€…</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="cardKeyTableBody">
                            <tr>
                                <td colspan="6" class="loading-cell">åŠ è½½ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ç”¨æˆ·åˆ—è¡¨ -->
        <div class="admin-section">
            <h2 class="section-title">ç”¨æˆ·åˆ—è¡¨</h2>
            <div class="user-table-container">
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ç”¨æˆ·å</th>
                            <th>è§’è‰²</th>
                            <th>ç‚¹æ•°</th>
                            <th>ä¼šè¯æ•°</th>
                            <th>æ¶ˆæ¯æ•°</th>
                            <th>æ³¨å†Œæ—¶é—´</th>

                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <tr>
                            <td colspan="7" class="loading-cell">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ç”¨æˆ·ä¼šè¯è¯¦æƒ…æ¨¡æ€æ¡† (Master-Detail Layout) -->
        <div class="modal" id="sessionModal" hidden>
            <div class="modal-backdrop" onclick="closeSessionModal()"></div>
            <div class="modal-content modal-large-xl">
                <div class="modal-header">
                    <h3 id="modalTitle">ç”¨æˆ·ä¼šè¯è¯¦æƒ…</h3>
                    <button class="modal-close" onclick="closeSessionModal()">Ã—</button>
                </div>
                <div class="modal-body" id="sessionModalBody" style="padding: 0; overflow: hidden;">
                    <!-- Content will be injected here -->
                    <div class="session-viewer-container">
                        <div class="session-viewer-sidebar">
                            <div class="session-viewer-sidebar-header">
                                ä¼šè¯åˆ—è¡¨
                            </div>
                            <div class="session-viewer-list" id="sessionSidebarList">
                                <!-- List Items -->
                            </div>
                        </div>
                        <div class="session-viewer-main">
                            <div class="session-viewer-content" id="sessionMainContent">
                                <!-- Chat Content -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† (Lightbox) -->
        <div class="image-modal" id="adminImageModal" hidden>
            <div class="modal-backdrop" onclick="closeImagePreview()"></div>
            <div class="modal-content">
                <img id="adminModalImage" src="" alt="å¤§å›¾é¢„è§ˆ">
                <div class="modal-actions">
                    <a class="btn-download" id="adminBtnDownload" download>
                        <span>ğŸ“¥</span> ä¸‹è½½å›¾ç‰‡
                    </a>
                    <button class="btn-close-modal" onclick="closeImagePreview()">âœ•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥è‡ªå®šä¹‰ Modal æ ·å¼ -->
    <link rel="stylesheet" href="/static/css/modal.css">
    <!-- å¼•å…¥è‡ªå®šä¹‰ Modal è„šæœ¬ -->
    <script src="/static/js/modal.js"></script>

    <script>
        let users = [];
        let currentSessions = []; // Store current user sessions

        // åŠ è½½ç”¨æˆ·æ•°æ®
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                if (response.ok) {
                    users = await response.json();
                    renderUsers();
                    updateStats();
                } else if (response.status === 401) {
                    window.location.href = '/login';
                } else if (response.status === 403) {
                    await Modal.alert('æƒé™é”™è¯¯', 'æ‚¨æ²¡æœ‰ç®¡ç†å‘˜æƒé™', 'error');
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error);
                Modal.toast('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥', 'error');
            }
        }

        // æ¸²æŸ“ç”¨æˆ·è¡¨æ ¼
        function renderUsers() {
            const tbody = document.getElementById('userTableBody');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-cell">æš‚æ— ç”¨æˆ·</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr class="${user.is_admin ? 'admin-row' : ''}">
                    <td>${user.id}</td>
                    <td>
                        <span class="username">${user.username}</span>
                        ${user.username === 'admin' ? '<span class="badge badge-primary">ä¸»ç®¡ç†å‘˜</span>' : ''}
                    </td>
                    <td>
                        <span class="badge ${user.is_admin ? 'badge-admin' : 'badge-user'}">
                            ${user.is_admin ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'}
                        </span>
                    </td>
                    <td>${user.credits !== undefined ? user.credits : '-'}</td>
                    <td>${user.session_count || 0}</td>
                    <td>${user.message_count || 0}</td>
                    <td>${formatDate(user.created_at)}</td>
                    <td class="action-cell">
                        <button class="btn-action btn-view" onclick="viewSessions(${user.id}, '${user.username}')">
                            æŸ¥çœ‹ä¼šè¯
                        </button>
                        ${user.username !== 'admin' ? `
                            <button class="btn-action btn-toggle" onclick="toggleAdmin(${user.id})">
                                ${user.is_admin ? 'å–æ¶ˆç®¡ç†å‘˜' : 'è®¾ä¸ºç®¡ç†å‘˜'}
                            </button>
                            <button class="btn-action btn-view" onclick="addCredits(${user.id}, '${user.username}')">
                                å……å€¼
                            </button>
                            <button class="btn-action btn-delete" onclick="deleteUser(${user.id}, '${user.username}')">
                                åˆ é™¤
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('totalSessions').textContent = users.reduce((sum, u) => sum + (u.session_count || 0), 0);
            document.getElementById('totalMessages').textContent = users.reduce((sum, u) => sum + (u.message_count || 0), 0);
            document.getElementById('totalAdmins').textContent = users.filter(u => u.is_admin).length;
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // æŸ¥çœ‹ç”¨æˆ·ä¼šè¯
        async function viewSessions(userId, username) {
            document.getElementById('modalTitle').textContent = `${username} çš„ä¼šè¯è®°å½•`;
            document.getElementById('sessionModal').hidden = false;

            // Reset UI
            const sidebarList = document.getElementById('sessionSidebarList');
            const mainContent = document.getElementById('sessionMainContent');
            sidebarList.innerHTML = '<div style="padding:10px; color:var(--text-muted)">åŠ è½½ä¸­...</div>';
            mainContent.innerHTML = '';

            try {
                const response = await fetch(`/api/admin/users/${userId}/sessions`);
                currentSessions = await response.json();

                if (currentSessions.length === 0) {
                    sidebarList.innerHTML = '<div style="padding:10px; color:var(--text-muted)">æš‚æ— ä¼šè¯</div>';
                    renderEmptyState();
                    return;
                }

                renderSessionList();
                // Select first session by default
                if (currentSessions.length > 0) {
                    selectSession(currentSessions[0].id);
                }

            } catch (error) {
                sidebarList.innerHTML = '<div style="padding:10px; color:var(--error)">åŠ è½½å®Œå…¨å¤±è´¥</div>';
                Modal.toast('åŠ è½½ä¼šè¯å¤±è´¥', 'error');
            }
        }

        function renderSessionList() {
            const sidebarList = document.getElementById('sessionSidebarList');
            sidebarList.innerHTML = currentSessions.map(session => `
                <div class="session-list-item" id="session-item-${session.id}" onclick="selectSession('${session.id}')">
                    <div class="session-list-item-title">${session.title || 'æ–°å¯¹è¯'}</div>
                    <div class="session-list-item-date">${formatDate(session.updated_at)} Â· ${session.messages.length} æ¡æ¶ˆæ¯</div>
                </div>
            `).join('');
        }

        function selectSession(sessionId) {
            // Update active state in sidebar
            document.querySelectorAll('.session-list-item').forEach(el => el.classList.remove('active'));
            const activeItem = document.getElementById(`session-item-${sessionId}`);
            if (activeItem) activeItem.classList.add('active');

            // Render messages
            const session = currentSessions.find(s => s.id === sessionId);
            const mainContent = document.getElementById('sessionMainContent');

            if (!session || !session.messages || session.messages.length === 0) {
                mainContent.innerHTML = `
                    <div class="viewer-empty">
                        <div class="viewer-empty-icon">ğŸ’¬</div>
                        <p>æ­¤ä¼šè¯æš‚æ— æ¶ˆæ¯</p>
                    </div>
                `;
                return;
            }

            mainContent.innerHTML = session.messages.map(msg => `
                <div class="viewer-message ${msg.role}">
                    <div class="viewer-avatar">${msg.role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–'}</div>
                    <div class="viewer-content-wrapper">
                         <div class="viewer-bubble">
                            ${msg.content || ''}
                            ${msg.image ? `<img src="${msg.thumbnail || msg.image}" class="viewer-image" alt="ç”Ÿæˆå›¾ç‰‡" onclick="openImagePreview('${msg.image}')">` : ''}
                        </div>
                         <!-- Reference Images -->
                         ${msg.reference_images ? `
                            <div style="margin-top: 5px; display: flex; gap: 5px; flex-wrap: wrap;">
                                ${msg.reference_images.map(ref => `
                                    <img src="/static/images/${ref}" style="width: 40px; height: 40px; border-radius: 4px; object-fit: cover; border: 1px solid rgba(255,255,255,0.1);">
                                `).join('')}
                            </div>
                         ` : ''}
                    </div>
                </div>
            `).join('');

            // Scroll to bottom
            setTimeout(() => {
                mainContent.scrollTop = mainContent.scrollHeight;
            }, 0);
        }

        function renderEmptyState() {
            const mainContent = document.getElementById('sessionMainContent');
            mainContent.innerHTML = `
                <div class="viewer-empty">
                    <div class="viewer-empty-icon">ğŸ“‚</div>
                    <p>è¯·åœ¨å·¦ä¾§é€‰æ‹©ä¸€ä¸ªä¼šè¯æŸ¥çœ‹è¯¦æƒ…</p>
                </div>
            `;
        }

        // å…³é—­ä¼šè¯æ¨¡æ€æ¡†
        function closeSessionModal() {
            document.getElementById('sessionModal').hidden = true;
        }

        // åˆ‡æ¢ç®¡ç†å‘˜çŠ¶æ€
        async function toggleAdmin(userId) {
            try {
                const response = await fetch(`/api/admin/users/${userId}/toggle-admin`, {
                    method: 'POST'
                });
                const data = await response.json();
                if (response.ok) {
                    Modal.toast(`æ“ä½œæˆåŠŸ`, 'success');
                    loadUsers();
                } else {
                    Modal.alert('æ“ä½œå¤±è´¥', data.error || 'æœªçŸ¥é”™è¯¯', 'error');
                }
            } catch (error) {
                Modal.alert('ç½‘ç»œé”™è¯¯', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨', 'error');
            }
        }

        // åˆ é™¤ç”¨æˆ·
        async function deleteUser(userId, username) {
            const confirmed = await Modal.confirm('åˆ é™¤ç”¨æˆ·', `ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${username}" å—ï¼Ÿ<br>æ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œå°†åˆ é™¤è¯¥ç”¨æˆ·çš„æ‰€æœ‰æ•°æ®ï¼`, 'warning');
            if (!confirmed) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (response.ok) {
                    Modal.toast(`ç”¨æˆ· ${username} å·²åˆ é™¤`, 'success');
                    loadUsers();
                } else {
                    Modal.alert('åˆ é™¤å¤±è´¥', data.error || 'æœªçŸ¥é”™è¯¯', 'error');
                }
            } catch (error) {
                Modal.alert('ç½‘ç»œé”™è¯¯', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨', 'error');
            }
        }

        // ç»™ç”¨æˆ·å……å€¼
        async function addCredits(userId, username) {
            const amountStr = await Modal.prompt('ç‚¹æ•°å……å€¼', `è¯·è¾“å…¥è¦ç»™ç”¨æˆ· "${username}" å……å€¼çš„ç‚¹æ•°ï¼ˆè´Ÿæ•°è¡¨ç¤ºæ‰£é™¤ï¼‰ï¼š`, '10');
            if (amountStr === null) return;

            const amount = parseInt(amountStr);
            if (isNaN(amount) || amount === 0) {
                Modal.toast('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—', 'warning');
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}/credits`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount })
                });
                const data = await response.json();

                if (response.ok) {
                    await Modal.alert('å……å€¼æˆåŠŸ', `å……å€¼æˆåŠŸï¼ç”¨æˆ·ç°æœ‰ ${data.new_credits} ç‚¹`, 'success');
                    loadUsers();
                } else {
                    Modal.alert('å……å€¼å¤±è´¥', data.error || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                Modal.alert('ç½‘ç»œé”™è¯¯', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨', 'error');
            }
        }

        // æ•°æ®æ¸…ç†å‡½æ•°
        async function cleanupData(days) {
            const confirmed = await Modal.confirm('æ•°æ®æ¸…ç†', `ç¡®å®šè¦æ¸…ç† ${days} å¤©å‰çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿ<br>æ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼`, 'warning');
            if (!confirmed) {
                return;
            }

            const date = new Date();
            date.setDate(date.getDate() - days);
            const cutoffDate = date.toISOString().split('T')[0]; // YYYY-MM-DD

            await performCleanup(cutoffDate);
        }

        async function cleanupDataCustom() {
            const dateInput = document.getElementById('cleanupDate');
            const cutoffDate = dateInput.value;

            if (!cutoffDate) {
                Modal.toast('è¯·é€‰æ‹©æ—¥æœŸ', 'warning');
                return;
            }

            const confirmed = await Modal.confirm('è‡ªå®šä¹‰æ¸…ç†', `ç¡®å®šè¦æ¸…ç† ${cutoffDate} ä¹‹å‰çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿ<br>æ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼`, 'warning');
            if (!confirmed) {
                return;
            }

            await performCleanup(cutoffDate);
        }

        async function performCleanup(cutoffDate) {
            try {
                const response = await fetch('/api/admin/cleanup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cutoff_date: cutoffDate })
                });

                const data = await response.json();

                if (response.ok) {
                    const stats = data.deleted_stats;
                    let message = `æ¸…ç†å®Œæˆï¼\nåˆ é™¤æ¶ˆæ¯æ•°: ${stats.messages}\nåˆ é™¤å›¾ç‰‡æ•°: ${stats.images}\nåˆ é™¤ç©ºä¼šè¯æ•°: ${stats.sessions}`;
                    if (stats.orphan_images > 0 || stats.orphan_thumbnails > 0) {
                        message += `\n\nå­¤å„¿æ–‡ä»¶æ¸…ç†:\n- å­¤å„¿å›¾ç‰‡: ${stats.orphan_images} ä¸ª\n- å­¤å„¿ç¼©ç•¥å›¾: ${stats.orphan_thumbnails} ä¸ª`;
                    }
                    await Modal.alert('æ¸…ç†å®Œæˆ', message, 'success');
                    loadUsers(); // åˆ·æ–°æ•°æ®
                } else {
                    Modal.alert('æ¸…ç†å¤±è´¥', data.error || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                Modal.alert('ç½‘ç»œé”™è¯¯', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨', 'error');
            }
        }

        // å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
        function openImagePreview(imageSrc) {
            const modal = document.getElementById('adminImageModal');
            const img = document.getElementById('adminModalImage');
            const downloadBtn = document.getElementById('adminBtnDownload');

            img.src = imageSrc;
            downloadBtn.href = imageSrc;
            modal.hidden = false;
        }

        function closeImagePreview() {
            document.getElementById('adminImageModal').hidden = true;
        }

        // ========================================
        // å¡å¯†ç®¡ç†åŠŸèƒ½
        // ========================================
        let cardKeys = [];

        async function loadCardKeys() {
            try {
                const response = await fetch('/api/admin/card-keys');
                if (response.ok) {
                    cardKeys = await response.json();
                    renderCardKeys();
                }
            } catch (error) {
                console.error('åŠ è½½å¡å¯†å¤±è´¥:', error);
            }
        }

        function renderCardKeys() {
            const tbody = document.getElementById('cardKeyTableBody');
            if (cardKeys.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-cell">æš‚æ— å¡å¯†</td></tr>';
                return;
            }

            tbody.innerHTML = cardKeys.map(key => `
                <tr class="${key.is_used ? 'used-row' : ''}">
                    <td>
                        <code class="card-key-code">${key.code_prefix}****-****-****</code>
                    </td>
                    <td><span class="credits-badge">ğŸª™ ${key.credits}</span></td>
                    <td>
                        <span class="badge ${key.is_used ? 'badge-used' : 'badge-available'}">
                            ${key.is_used ? 'å·²ä½¿ç”¨' : 'å¯ç”¨'}
                        </span>
                    </td>
                    <td>${key.used_by_username || '-'}</td>
                    <td>${formatDate(key.created_at)}</td>
                    <td>-</td>
                </tr>
            `).join('');
        }

        async function generateCardKeys() {
            const credits = parseInt(document.getElementById('cardKeyCredits').value);
            const count = parseInt(document.getElementById('cardKeyCount').value);

            if (isNaN(credits) || credits <= 0) {
                Modal.toast('è¯·è¾“å…¥æœ‰æ•ˆçš„ç‚¹æ•°', 'warning');
                return;
            }
            if (isNaN(count) || count <= 0 || count > 100) {
                Modal.toast('æ•°é‡å¿…é¡»åœ¨1-100ä¹‹é—´', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/admin/card-keys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ credits, count })
                });

                const data = await response.json();

                if (response.ok) {
                    // æ˜¾ç¤ºç”Ÿæˆçš„å¡å¯†ï¼ˆåªæ˜¾ç¤ºä¸€æ¬¡ï¼‰
                    const keysHTML = data.keys.map(key => `
                        <div style="margin-bottom: 8px; padding: 10px; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">
                            <code style="font-size: 1rem; font-weight: 600; color: var(--accent-purple-light); letter-spacing: 1px;">${key.code}</code>
                            <button onclick="navigator.clipboard.writeText('${key.code}').then(() => Modal.toast('å·²å¤åˆ¶', 'success'))" style="margin-left: 10px; padding: 4px 8px; background: rgba(99, 102, 241, 0.2); color: var(--accent-blue); border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ğŸ“‹ å¤åˆ¶</button>
                        </div>
                    `).join('');

                    await Modal.alert(
                        'ğŸ« å¡å¯†ç”ŸæˆæˆåŠŸ',
                        `<div style="max-height: 400px; overflow-y: auto;">
                            <p style="color: #f59e0b; font-weight: 600; margin-bottom: 12px;">âš ï¸ è¯·ç«‹å³ä¿å­˜è¿™äº›å¡å¯†ï¼Œå…³é—­åå°†æ— æ³•å†æŸ¥çœ‹å®Œæ•´å¡å¯†ï¼</p>
                            ${keysHTML}
                        </div>`,
                        'success'
                    );
                    loadCardKeys();
                } else {
                    Modal.alert('ç”Ÿæˆå¤±è´¥', data.error || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                Modal.alert('ç½‘ç»œé”™è¯¯', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨', 'error');
            }
        }

        function copyCardKey(code) {
            navigator.clipboard.writeText(code).then(() => {
                Modal.toast('å¡å¯†å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(() => {
                Modal.toast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // åˆå§‹åŒ–
        loadUsers();
        loadCardKeys();
    </script>
</body>

</html>