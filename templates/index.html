<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title data-i18n="page_title">ç è¨€æ——ä¸‹Nano Banana Pro AIå›¾ç‰‡ç”Ÿæˆå™¨</title>
    <link rel="icon" href="/static/logo.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="/static/fonts/inter.css" rel="stylesheet">
    <script src="/static/js/i18n.js"></script>
</head>

<body>
    <!-- é¡¶éƒ¨æ¨ªå¹… -->
    <header class="top-banner">
        <!-- æ±‰å ¡èœå•æŒ‰é’®ï¼ˆç§»åŠ¨ç«¯ï¼‰ -->
        <button class="hamburger-btn" id="hamburgerBtn" aria-label="æ‰“å¼€èœå•">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
        </button>
        <!-- å·¦ä¾§logoå’Œæ ‡é¢˜ -->
        <div class="site-header">
            <img src="/static/logo.ico" alt="Logo" class="site-logo">
            <div class="site-title-group">
                <span class="site-title" data-i18n="site_title">ç è¨€nano</span>
                <span class="site-subtitle" data-i18n="site_subtitle">åœ¨çº¿ä½¿ç”¨Nano Banana Pro</span>
            </div>
        </div>
        <!-- ä¸­é—´å†…å®¹ -->
        <div class="banner-content">
            <span class="banner-text" data-i18n="banner_brand">ç è¨€æ——ä¸‹</span>
            <span class="banner-highlight" data-i18n="banner_product">ğŸŒ Nano Banana Pro</span>
            <span class="banner-text" data-i18n="banner_desc">4K AIå›¾ç‰‡ç”Ÿæˆå™¨</span>
            <span class="banner-divider">|</span>
            <span class="banner-price" data-i18n="banner_price">$0.04èµ·/å¼ </span>
            <span class="banner-divider">|</span>
            <span class="banner-tag trial" data-i18n="banner_trial">å…è´¹è¯•ç”¨</span>
        </div>
        <!-- å³ä¾§ç”¨æˆ·ä¿¡æ¯ -->
        <div class="user-menu">
            <!-- è¯­è¨€åˆ‡æ¢ -->
            <div class="lang-switch">
                <button class="lang-btn" data-lang="zh">ä¸­</button>
                <button class="lang-btn" data-lang="en">EN</button>
            </div>
            {% if user %}
            <span class="user-credits" id="userCredits" data-i18n-title="credits_label">ğŸª™ {{ user.credits }} <span
                    data-i18n="credits_label">ç‚¹</span></span>
            <button class="btn-recharge" id="btnRecharge" data-i18n="recharge_btn">ğŸ’³ å……å€¼</button>
            {% endif %}
            <span class="user-name">ğŸ‘¤ {{ session.username }}</span>
            {% if session.is_admin %}
            <a href="/admin" class="btn-admin" data-i18n="admin_panel">ç®¡ç†åå°</a>
            {% endif %}
            <a href="/api/logout" class="btn-user-logout" data-i18n="logout">é€€å‡º</a>
        </div>
    </header>

    <!-- ä¾§è¾¹æ é®ç½©å±‚ï¼ˆç§»åŠ¨ç«¯ï¼‰ -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="app-container">
        <!-- å·¦ä¾§è¾¹æ  - ä¼šè¯åˆ—è¡¨ -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-header-top">
                    <h1 class="logo">
                        <span class="logo-icon">ğŸŒ</span>
                        <span class="logo-text">
                            <span class="logo-brand" data-i18n="sidebar_brand">ç è¨€æ——ä¸‹</span>
                            <span class="logo-name">Nano Banana Pro</span>
                        </span>
                    </h1>
                    <button class="sidebar-close-btn" id="sidebarCloseBtn" aria-label="å…³é—­èœå•"
                        data-i18n-title="close_menu">âœ•</button>
                </div>
                <button class="btn-new-chat" id="btnNewChat">
                    <span class="icon">+</span>
                    <span data-i18n="new_chat">æ–°å¯¹è¯</span>
                </button>
            </div>
            <div class="session-list" id="sessionList">
                <!-- ä¼šè¯åˆ—è¡¨é¡¹ä¼šåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="control-panel">
                <!-- å‚è€ƒå›¾ä¸Šä¼  -->
                <div class="control-section">
                    <div class="section-header">
                        <span class="section-icon">ğŸ–¼ï¸</span>
                        <span data-i18n="reference_images">å‚è€ƒå›¾ï¼ˆå¯é€‰ï¼‰</span>
                        <span class="section-hint" data-i18n="max_images_hint">æœ€å¤š14å¼ </span>
                    </div>
                    <div class="upload-container">
                        <div class="upload-area" id="uploadArea">
                            <input type="file" id="referenceImage" accept="image/*" multiple hidden>
                            <div class="upload-placeholder" id="uploadPlaceholder">
                                <div class="upload-icon">ğŸ“¤</div>
                                <div class="upload-text" data-i18n="upload">ä¸Šä¼ </div>
                                <div class="upload-hint" data-i18n="upload_hint">ç‚¹å‡»æˆ–æ‹–æ‹½</div>
                            </div>
                        </div>
                        <div class="preview-list" id="previewList">
                            <!-- é¢„è§ˆå›¾ç‰‡ä¼šåŠ¨æ€æ·»åŠ  -->
                        </div>
                    </div>
                    <p class="hint-text" data-i18n="upload_desc">å¯é€‰ï¼šä¸Šä¼ å‚è€ƒå›¾è¿›è¡Œå›¾ç”Ÿå›¾ã€‚æ”¯æŒæ‹–æ‹½æˆ–ç²˜è´´æˆªå›¾ï¼Œæœ€å¤š14å¼ </p>
                </div>

                <!-- æç¤ºè¯è¾“å…¥ -->
                <div class="control-section">
                    <div class="section-header">
                        <span class="section-icon">âœï¸</span>
                        <span data-i18n="prompt_label">æç¤ºè¯</span>
                    </div>
                    <textarea id="promptInput" class="prompt-input" data-i18n-placeholder="prompt_placeholder"
                        placeholder="ä¾‹å¦‚ï¼šä¸€åªå¯çˆ±çš„å°çŒ«å’ªååœ¨èŠ±å›­é‡Œï¼Œæ²¹ç”»é£æ ¼ï¼Œé«˜æ¸…ï¼Œç»†èŠ‚ä¸°å¯Œ" rows="4"></textarea>
                </div>



                <!-- åˆ†è¾¨ç‡å’Œå®½é«˜æ¯” -->
                <div class="control-section">
                    <div class="section-header">
                        <span class="section-icon">âš™ï¸</span>
                        <span data-i18n="aspect_resolution">çºµæ¨ªæ¯” & åˆ†è¾¨ç‡</span>
                    </div>

                    <!-- åˆ†è¾¨ç‡ -->
                    <div class="option-group" id="resolutionGroup">
                        <label class="option-label" data-i18n="resolution_label">åˆ†è¾¨ç‡(ä¸åŒåˆ†è¾¨ç‡æ¶ˆè€—ç‚¹æ•°æ•°ç›®ä¸åŒ)</label>
                        <div class="option-buttons" id="resolutionButtons">
                            <button class="option-btn resolution-btn active" data-value="1K">
                                <span class="res-label">1K</span>
                                <span class="res-cost-tag">ğŸª™ 1</span>
                            </button>
                            <button class="option-btn resolution-btn" data-value="2K">
                                <span class="res-label">2K</span>
                                <span class="res-cost-tag">ğŸª™ 2</span>
                            </button>
                            <button class="option-btn resolution-btn" data-value="4K">
                                <span class="res-label">4K</span>
                                <span class="res-cost-tag">ğŸª™ 4</span>
                            </button>
                        </div>
                    </div>

                    <!-- å®½é«˜æ¯” -->
                    <div class="option-group">
                        <label class="option-label" data-i18n="aspect_ratio_label">çºµæ¨ªæ¯”</label>
                        <div class="option-buttons aspect-ratio-buttons" id="aspectRatioButtons">
                            <button class="option-btn active" data-value="auto" data-i18n="aspect_auto">auto
                                è‡ªé€‚åº”</button>
                            <button class="option-btn" data-value="1:1" data-i18n="aspect_square">1:1 æ–¹å½¢</button>
                            <button class="option-btn" data-value="16:9" data-i18n="aspect_16_9">16:9 æ¨ªç‰ˆ</button>
                            <button class="option-btn" data-value="9:16" data-i18n="aspect_9_16">9:16 ç«–ç‰ˆ</button>
                            <button class="option-btn" data-value="4:3" data-i18n="aspect_4_3">4:3 æ¨ªç‰ˆ</button>
                            <button class="option-btn" data-value="3:4" data-i18n="aspect_3_4">3:4 ç«–ç‰ˆ</button>
                            <button class="option-btn" data-value="21:9" data-i18n="aspect_21_9">21:9 è¶…å®½</button>
                            <button class="option-btn" data-value="3:2" data-i18n="aspect_3_2">3:2 æ¨ªç‰ˆ</button>
                            <button class="option-btn" data-value="2:3" data-i18n="aspect_2_3">2:3 ç«–ç‰ˆ</button>
                        </div>
                    </div>
                    <p class="hint-text warning-hint" data-i18n="settings_warning">âš ï¸ æ›´æ”¹åˆ†è¾¨ç‡æˆ–çºµæ¨ªæ¯”ä¼šé‡ç½®å¯¹è¯è®°å¿†ï¼ŒAI å°†æ— æ³•è®°ä½ä¹‹å‰ç”Ÿæˆçš„å›¾ç‰‡
                    </p>
                </div>

                <!-- ç”ŸæˆæŒ‰é’® -->
                <div class="generate-section">
                    <button class="btn-generate" id="btnGenerate">
                        <span class="generate-icon">âœ¨</span>
                        <span data-i18n="generate_btn">ç”Ÿæˆå›¾ç‰‡</span>
                    </button>
                </div>
            </div>

            <!-- é¢„è§ˆåŒºåŸŸ -->
            <div class="preview-panel">
                <div class="preview-header">
                    <div class="preview-tabs">
                        <button class="preview-tab active">
                            <span class="tab-icon">ğŸ–¼ï¸</span>
                            <span data-i18n="chat_area">èŠå¤©åŒº</span>
                        </button>
                    </div>
                </div>
                <div class="preview-content" id="previewContent">
                    <div class="empty-state" id="emptyState">
                        <div class="empty-icon">ğŸ–¼ï¸</div>
                        <p class="empty-text" data-i18n="empty_state_title">å¯¹è¯å†…å®¹ä¸ç”Ÿæˆçš„å›¾ç‰‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                        <p class="empty-hint" data-i18n="empty_state_hint">åœ¨å·¦ä¾§è¾“å…¥æç¤ºè¯ï¼Œç‚¹å‡»ç”ŸæˆæŒ‰é’®å¼€å§‹åˆ›ä½œ</p>
                    </div>
                    <div class="message-list" id="messageList" hidden>
                        <!-- æ¶ˆæ¯ä¼šåŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- åŠ è½½é®ç½© -->
    <div class="loading-overlay" id="loadingOverlay" hidden>
        <div class="loading-spinner"></div>
        <p class="loading-text" data-i18n="loading_text">æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...</p>
        <p class="loading-hint" data-i18n="loading_hint">é¢„è®¡è€—æ—¶ 1 min</p>
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
    <div class="image-modal" id="imageModal" hidden>
        <div class="modal-backdrop" id="modalBackdrop"></div>
        <div class="modal-content">
            <img id="modalImage" src="" alt="" data-i18n-title="image_preview">
            <div class="modal-actions">
                <a class="btn-download" id="btnDownload" download data-i18n-html="download_image">
                    <span>ğŸ“¥</span> ä¸‹è½½å›¾ç‰‡
                </a>
                <button class="btn-close-modal" id="btnCloseModal">âœ•</button>
            </div>
        </div>
    </div>

    <!-- å……å€¼æ¨¡æ€æ¡† -->
    <div class="custom-modal-overlay" id="rechargeModalOverlay" style="display: none;">
        <div class="custom-modal recharge-modal">
            <div class="custom-modal-header">
                <h3 class="custom-modal-title">
                    <span class="custom-modal-icon">ğŸ’³</span>
                    <span data-i18n="recharge_title">ç‚¹æ•°å……å€¼</span>
                </h3>
                <button class="custom-modal-close-btn" id="closeRechargeModal">&times;</button>
            </div>
            <div class="custom-modal-body">
                <!-- å½“å‰ç‚¹æ•°æ˜¾ç¤º -->
                <div class="current-credits-display">
                    <span data-i18n="current_credits">å½“å‰ç‚¹æ•°ï¼š</span>
                    <span class="credits-value" id="rechargeModalCredits">{% if user %}{{ user.credits }}{% else %}0{%
                        endif %}</span>
                </div>
                <div class="recharge-section">
                    <div class="recharge-option">
                        <div class="recharge-option-icon">ğŸ›’</div>
                        <div class="recharge-option-info">
                            <h4 data-i18n="buy_card">è´­ä¹°å¡å¯†</h4>
                            <p data-i18n="buy_card_desc">åœ¨å•†åŸè´­ä¹°ç‚¹æ•°å¡å¯†ï¼Œè·å–å……å€¼ç </p>
                        </div>
                        <button class="btn-buy-card"
                            onclick="window.open('https://pay.ldxp.cn/shop/momo/fhrvq4', '_blank')" data-i18n="go_buy">
                            å»è´­ä¹° â†’
                        </button>
                    </div>
                </div>
                <div class="recharge-divider">
                    <span data-i18n="or">æˆ–</span>
                </div>
                <div class="recharge-section">
                    <div class="recharge-input-group">
                        <label data-i18n="enter_card_key">è¾“å…¥å¡å¯†å……å€¼</label>
                        <div class="recharge-input-row">
                            <input type="text" id="cardKeyInput" class="recharge-input"
                                data-i18n-placeholder="card_key_placeholder" placeholder="è¯·è¾“å…¥16ä½å¡å¯†ç " maxlength="20">
                            <button class="btn-redeem" id="btnRedeem" data-i18n="confirm_recharge">ç¡®è®¤å……å€¼</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç™»å½•/æ³¨å†Œæ¨¡æ€æ¡† -->
    <div class="auth-modal-overlay {% if not session.user_id %}auth-modal-show{% endif %}" id="authModalOverlay">
        <div class="auth-modal-content">
            <!-- è¯­è¨€åˆ‡æ¢ -->
            <div class="auth-lang-switch">
                <button class="lang-btn" data-lang="zh">ä¸­</button>
                <button class="lang-btn" data-lang="en">EN</button>
            </div>
            <!-- ç™»å½•è¡¨å• -->
            <div id="loginSection">
                <div class="auth-header">
                    <img src="/static/logo.ico" alt="Logo" class="auth-logo">
                    <h2 class="auth-title" data-i18n="welcome_back">æ¬¢è¿å›æ¥</h2>
                    <p class="auth-subtitle" data-i18n="login_subtitle">ç™»å½•ç è¨€ Nano Banana Pro åˆ›ä½œ</p>
                </div>
                <form class="auth-form" id="loginForm">
                    <div class="form-group">
                        <label data-i18n="username">ç”¨æˆ·å</label>
                        <input type="text" id="loginUsername" required data-i18n-placeholder="username_placeholder"
                            placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                    </div>
                    <div class="form-group">
                        <label data-i18n="password">å¯†ç </label>
                        <input type="password" id="loginPassword" required data-i18n-placeholder="password_placeholder"
                            placeholder="è¯·è¾“å…¥å¯†ç ">
                    </div>
                    <div class="form-error" id="loginError"></div>
                    <button type="submit" class="btn-auth btn-full" data-i18n="login_btn">ç™» å½•</button>
                </form>
                <div class="auth-footer">
                    <p><span data-i18n="no_account">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ</span><a href="#" onclick="switchAuthMode('register')"
                            data-i18n="register_now">ç«‹å³æ³¨å†Œ</a></p>
                </div>
            </div>

            <!-- æ³¨å†Œè¡¨å• -->
            <div id="registerSection" style="display: none;">
                <div class="auth-header">
                    <img src="/static/logo.ico" alt="Logo" class="auth-logo">
                    <h2 class="auth-title" data-i18n="create_account">åˆ›å»ºè´¦å·</h2>
                    <p class="auth-subtitle" data-i18n="register_subtitle">åŠ å…¥ç è¨€ Nano Banana Pro å¼€å¯ AI ä¹‹æ—…</p>
                </div>
                <form class="auth-form" id="registerForm">
                    <div class="form-group">
                        <label data-i18n="username">ç”¨æˆ·å</label>
                        <input type="text" id="regUsername" required data-i18n-placeholder="username_hint"
                            placeholder="è‡³å°‘3ä¸ªå­—ç¬¦" minlength="3">
                    </div>
                    <div class="form-group">
                        <label data-i18n="email">é‚®ç®±</label>
                        <input type="email" id="regEmail" required data-i18n-placeholder="email_placeholder"
                            placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€">
                    </div>
                    <div class="form-group">
                        <label data-i18n="verification_code">éªŒè¯ç </label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="regVerificationCode" required
                                data-i18n-placeholder="code_placeholder" placeholder="è¯·è¾“å…¥é‚®ç®±éªŒè¯ç " maxlength="6"
                                style="flex: 1; min-width: 80px;">
                            <button type="button" class="btn-send-code" id="btnSendCode" data-i18n="send_code"
                                style="flex-shrink: 0;">å‘é€éªŒè¯ç </button>
                        </div>
                        <small id="codeHint"
                            style="color: #666; font-size: 12px; display: none; margin-top: 5px;"></small>
                    </div>
                    <div class="form-group">
                        <label data-i18n="password">å¯†ç </label>
                        <input type="password" id="regPassword" required data-i18n-placeholder="password_hint"
                            placeholder="è‡³å°‘6ä¸ªå­—ç¬¦" minlength="6">
                    </div>
                    <div class="form-group">
                        <label data-i18n="confirm_password">ç¡®è®¤å¯†ç </label>
                        <input type="password" id="regConfirmPassword" required
                            data-i18n-placeholder="confirm_password_placeholder" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
                    </div>
                    <div class="form-error" id="registerError"></div>
                    <button type="submit" class="btn-auth btn-full" data-i18n="register_btn">æ³¨ å†Œ</button>
                </form>
                <div class="auth-footer">
                    <p><span data-i18n="has_account">å·²æœ‰è´¦å·ï¼Ÿ</span><a href="#" onclick="switchAuthMode('login')"
                            data-i18n="back_to_login">è¿”å›ç™»å½•</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥è‡ªå®šä¹‰ Modal æ ·å¼ -->
    <link rel="stylesheet" href="/static/css/modal.css">

    <script src="/static/js/main.js"></script>
    <!-- å¼•å…¥è‡ªå®šä¹‰ Modal è„šæœ¬ -->
    <script src="/static/js/modal.js"></script>
    <script>
        // è®¤è¯ç›¸å…³é€»è¾‘
        function switchAuthMode(mode) {
            const loginSection = document.getElementById('loginSection');
            const registerSection = document.getElementById('registerSection');
            const errorDivs = document.querySelectorAll('.form-error');

            errorDivs.forEach(div => div.textContent = '');

            if (mode === 'register') {
                loginSection.style.display = 'none';
                registerSection.style.display = 'block';
            } else {
                loginSection.style.display = 'block';
                registerSection.style.display = 'none';
            }
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            errorDiv.textContent = I18n.t('logging_in');

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    location.reload();
                } else {
                    const translatedError = I18n.translateError(data.error, 'login_failed');
                    errorDiv.textContent = translatedError;
                    Modal.toast(translatedError, 'error');
                }
            } catch (error) {
                errorDiv.textContent = I18n.t('network_error');
                Modal.toast(I18n.t('network_error'), 'error');
            }
        });


        // å‘é€éªŒè¯ç é€»è¾‘
        let countdownTimer = null;
        const btnSendCode = document.getElementById('btnSendCode');
        const regEmail = document.getElementById('regEmail');
        const codeHint = document.getElementById('codeHint');

        btnSendCode.addEventListener('click', async () => {
            const email = regEmail.value.trim();

            if (!email) {
                Modal.toast(I18n.t('enter_email_first'), 'warning');
                regEmail.focus();
                return;
            }

            // ç®€å•çš„é‚®ç®±æ ¼å¼éªŒè¯
            const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (!emailPattern.test(email)) {
                Modal.toast(I18n.t('invalid_email'), 'warning');
                regEmail.focus();
                return;
            }

            btnSendCode.disabled = true;
            btnSendCode.textContent = I18n.t('logging_in').replace('ç™»å½•', I18n.t('send_code').split(' ')[0]);

            try {
                const response = await fetch('/api/send-verification-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();

                if (response.ok) {
                    Modal.toast(I18n.t('code_sent'), 'success');
                    codeHint.textContent = I18n.t('code_sent_hint');
                    codeHint.style.display = 'block';
                    codeHint.style.color = '#28a745';

                    // å¼€å§‹60ç§’å€’è®¡æ—¶
                    let countdown = 60;
                    btnSendCode.textContent = `${countdown}${I18n.t('seconds_retry')}`;

                    countdownTimer = setInterval(() => {
                        countdown--;
                        if (countdown > 0) {
                            btnSendCode.textContent = `${countdown}${I18n.t('seconds_retry')}`;
                        } else {
                            clearInterval(countdownTimer);
                            btnSendCode.disabled = false;
                            btnSendCode.textContent = I18n.t('send_code');
                        }
                    }, 1000);
                } else {
                    // ç¿»è¯‘åç«¯é”™è¯¯æ¶ˆæ¯
                    const translatedError = I18n.translateError(data.error, 'send_failed');
                    Modal.toast(translatedError, 'error');
                    btnSendCode.disabled = false;
                    btnSendCode.textContent = I18n.t('send_code');
                }
            } catch (error) {
                Modal.toast(I18n.t('network_error'), 'error');
                btnSendCode.disabled = false;
                btnSendCode.textContent = I18n.t('send_code');
            }
        });

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value.trim();
            const verificationCode = document.getElementById('regVerificationCode').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            const errorDiv = document.getElementById('registerError');

            if (password !== confirmPassword) {
                errorDiv.textContent = I18n.t('passwords_not_match');
                Modal.toast(I18n.t('passwords_not_match'), 'warning');
                return;
            }

            if (!verificationCode) {
                errorDiv.textContent = I18n.t('enter_code');
                Modal.toast(I18n.t('enter_code'), 'warning');
                return;
            }

            errorDiv.textContent = I18n.t('registering');

            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password, verification_code: verificationCode })
                });

                const data = await response.json();

                if (response.ok) {
                    await Modal.alert(I18n.t('register_success'), I18n.t('register_success_msg'), 'success');
                    switchAuthMode('login');
                    document.getElementById('loginUsername').value = username;
                    document.getElementById('loginPassword').focus();
                } else {
                    const translatedError = I18n.translateError(data.error, 'register_failed');
                    errorDiv.textContent = translatedError;
                    Modal.toast(translatedError, 'error');
                }
            } catch (error) {
                errorDiv.textContent = I18n.t('network_error');
                Modal.toast(I18n.t('network_error'), 'error');
            }
        });

        // ========================================
        // å……å€¼æ¨¡æ€æ¡†é€»è¾‘
        // ========================================
        const rechargeModalOverlay = document.getElementById('rechargeModalOverlay');
        const btnRecharge = document.getElementById('btnRecharge');
        const closeRechargeModal = document.getElementById('closeRechargeModal');
        const btnRedeem = document.getElementById('btnRedeem');
        const cardKeyInput = document.getElementById('cardKeyInput');

        // æ‰“å¼€å……å€¼å¼¹çª—
        if (btnRecharge) {
            btnRecharge.addEventListener('click', () => {
                rechargeModalOverlay.style.display = 'flex';
                // ä½¿ç”¨ setTimeout ç¡®ä¿ display å…ˆç”Ÿæ•ˆï¼Œç„¶åå†è§¦å‘è¿‡æ¸¡åŠ¨ç”»
                setTimeout(() => {
                    rechargeModalOverlay.classList.add('active');
                }, 10);
            });
        }

        // å…³é—­å……å€¼å¼¹çª—
        function closeRechargeModalFunc() {
            rechargeModalOverlay.classList.remove('active');
            // ç­‰å¾…è¿‡æ¸¡åŠ¨ç”»ç»“æŸåéšè—å…ƒç´ 
            setTimeout(() => {
                rechargeModalOverlay.style.display = 'none';
            }, 300);
        }

        if (closeRechargeModal) {
            closeRechargeModal.addEventListener('click', closeRechargeModalFunc);
        }

        // ç‚¹å‡»é®ç½©å…³é—­
        if (rechargeModalOverlay) {
            rechargeModalOverlay.addEventListener('click', (e) => {
                if (e.target === rechargeModalOverlay) {
                    closeRechargeModalFunc();
                }
            });
        }

        // ä½¿ç”¨å¡å¯†å……å€¼
        if (btnRedeem) {
            btnRedeem.addEventListener('click', async () => {
                const code = cardKeyInput.value.trim();

                if (!code) {
                    Modal.toast(I18n.t('enter_card_key_msg'), 'warning');
                    cardKeyInput.focus();
                    return;
                }

                btnRedeem.disabled = true;
                btnRedeem.textContent = I18n.t('recharging');

                try {
                    const response = await fetch('/api/redeem', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // ä½¿ç”¨ç¿»è¯‘åçš„æˆåŠŸæ¶ˆæ¯ï¼Œæ ¼å¼ï¼šå……å€¼æˆåŠŸï¼ç”¨æˆ·ç°æœ‰ X ç‚¹
                        const successMsg = I18n.t('recharge_success_msg').replace('{0}', data.new_credits);
                        Modal.toast(successMsg, 'success');
                        // æ›´æ–°ç‚¹æ•°æ˜¾ç¤º
                        const creditEl = document.getElementById('userCredits');
                        if (creditEl) {
                            creditEl.innerHTML = `ğŸª™ ${data.new_credits} <span data-i18n="credits_label">${I18n.t('credits_label')}</span>`;
                        }
                        // å…³é—­å¼¹çª—å¹¶æ¸…ç©ºè¾“å…¥
                        cardKeyInput.value = '';
                        closeRechargeModalFunc();
                    } else {
                        Modal.toast(I18n.translateError(data.error, 'recharge_failed'), 'error');
                    }
                } catch (error) {
                    Modal.toast(I18n.t('network_error'), 'error');
                } finally {
                    btnRedeem.disabled = false;
                    btnRedeem.textContent = I18n.t('confirm_recharge');
                }
            });
        }

        // å›è½¦æäº¤å¡å¯†
        if (cardKeyInput) {
            cardKeyInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    btnRedeem.click();
                }
            });
        }
    </script>
</body>

</html>